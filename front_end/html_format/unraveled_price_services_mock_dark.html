<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unraveled - Price Services</title>
  <style>
    :root{
      --bg:#1f2546;
      --text:#ebebeb;
      --muted:#b5b5bc;
      --border:rgba(235,235,235,.20);
      --accent:#358f97;
      --good:#358f97;
      --warn:#f1e0ab;
      --bad:#feeebd;
      --shadow: 0 10px 28px rgba(31,37,70,.12);
      --radius: 16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 18% -10%, rgba(53,143,151,.18), transparent 60%),
                  radial-gradient(1200px 600px at 92% 10%, rgba(241,224,171,.30), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.35;
    }
    .wrap{ max-width:1240px; margin:0 auto; padding:22px 18px 44px; }
    header{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:16px; margin-bottom:14px;
    }
    h1{ font-size:33px; margin:0 0 6px; letter-spacing:.2px; line-height:1.1; }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:4px;
    }
    .brandLogo{
      width:48px;
      height:48px;
      object-fit:contain;
      border-radius:8px;
      border:none;
      background:transparent;
    }
    .sub{ color:var(--muted); font-size:13px; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--border);
      border-radius:999px; background:rgba(255,255,255,.04);
      color:var(--muted); font-size:12px; white-space:nowrap;
    }

    .toprow{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .toprow{ grid-template-columns:1fr; } }
    .toprow > .panel{
      min-height:360px;
      display:flex;
      flex-direction:column;
    }

    .panel{
      border:1px solid var(--border); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      box-shadow: var(--shadow); overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 12px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .panel .hd h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .panel .hd .hint{ color:var(--muted); font-size:12px; }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(53,143,151,.08);
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 10px; border:1px solid var(--border);
      border-radius:14px; background:rgba(255,255,255,.65);
      border-color:rgba(235,235,235,.45);
      color:#1f2546; font-size:12px;
    }
    .chip span{ color:#358f97; font-size:11px; }
    .input{
      flex:1 1 220px;
      display:flex; align-items:center; gap:10px;
      padding:9px 10px; border:1px solid var(--border);
      border-radius:14px; background:rgba(255,255,255,.65);
      border-color:rgba(235,235,235,.45);
      color:#1f2546; font-size:12px;
    }
    .input input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:#1f2546;
      font-size:12px;
    }
    .input input::placeholder{ color:#1f2546; }

    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
    thead th{
      text-align:left; color:var(--muted); font-weight:650; font-size:12px;
      padding:10px 12px; border-bottom:1px solid var(--border);
      background:rgba(31,37,70,.92);
      border-top:1px solid rgba(254,238,189,.18);
      box-shadow: inset 0 -1px 0 rgba(254,238,189,.16);
      position:sticky; top:0; z-index:1;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid rgba(235,235,235,.10);
      background:rgba(255,255,255,.03);
      vertical-align:middle;
    }
    tbody tr{ transition: background .12s ease; cursor:pointer; }
    tbody tr:hover{ background:rgba(53,143,151,.12); }
    tbody tr.active{
      background:rgba(53,143,151,.16);
      outline:1px solid rgba(53,143,151,.35);
      outline-offset:-1px;
    }

    .rank{ width:44px; color:var(--muted); }
    .hospital{ font-weight:700; margin-bottom:2px; }
    .addr{ color:#b5b5bc; font-size:12px; }
    .money{ color:#feeebd; font-variant-numeric: tabular-nums; font-weight:800; letter-spacing:.2px; white-space:nowrap; }
    #hospitalTable .money{ color:var(--text); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      font-size:12px; color:var(--muted);
      background:rgba(31,37,70,.05); white-space:nowrap;
    }
    .delta.good{ color:var(--good); }
    .delta.warn{ color:var(--warn); }
    .delta.bad{ color:var(--bad); }

    /* Map */
    .map{
      height:360px; position:relative;
      flex:1;
      background:
        radial-gradient(820px 360px at 20% 20%, rgba(53,143,151,.22), transparent 55%),
        radial-gradient(640px 280px at 90% 40%, rgba(241,224,171,.32), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.12));
    }
    .map .gridlines{
      position:absolute; inset:0;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 44px 44px; opacity:.35; pointer-events:none;
    }
    .pin{
      position:absolute; width:28px; height:28px; border-radius:999px;
      border:1px solid rgba(31,37,70,.22);
      background:rgba(255,255,255,.88);
      box-shadow: 0 8px 20px rgba(31,37,70,.14);
      display:flex; align-items:center; justify-content:center;
      color:#1f2546;
      text-shadow:0 1px 0 rgba(255,255,255,.28);
      font-weight:900; font-size:12px; cursor:pointer;
      transform: translate(-50%, -50%);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .pin:hover{
      transform: translate(-50%, -50%) scale(1.08);
      color:#ebebeb;
      background:rgba(53,143,151,.82);
      border-color: rgba(53,143,151,.58);
    }
    .pin.active{
      color:#ebebeb;
      background: rgba(53,143,151,.95);
      border-color: rgba(53,143,151,.70);
    }

    .mapCard{
      position:absolute; min-width:260px; max-width:340px;
      right:14px; bottom:14px;
      border:1px solid var(--border);
      border-radius:14px; background:rgba(255,255,255,.94);
      box-shadow: var(--shadow); padding:12px; display:none;
    }
    .mapCard .t{ font-weight:800; margin:0 0 4px; }
    .mapCard .s{ color:var(--muted); font-size:12px; margin:0 0 10px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:9px 10px; border-radius:12px;
      border:1px solid rgba(53,143,151,.45);
      background:rgba(53,143,151,.17);
      color:var(--text); font-weight:700; font-size:12px;
      cursor:pointer; text-decoration:none; user-select:none;
    }
    .btn:hover{ background:rgba(53,143,151,.24); }

    /* Detail */
    .detailHeader{
      padding:14px;
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; flex-wrap:wrap;
    }
    .detailHeader .left .name{ font-size:16px; font-weight:900; margin:0 0 4px; }
    .detailHeader .left .meta{ margin:0; color:var(--muted); font-size:12px; }
    .kpis{ display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; }
    .kpi{
      padding:10px 12px; border:1px solid var(--border);
      border-radius:14px; background:rgba(255,255,255,.22);
      min-width:190px;
    }
    .kpi .label{ color:var(--muted); font-size:11px; }
    .kpi .value{ margin-top:4px; font-weight:900; font-variant-numeric: tabular-nums; }

    .serviceGrid{
      border-top:1px solid rgba(255,255,255,.10);
      max-height:420px;
      overflow:auto;
    }
    .serviceName{ font-weight:750; }
    .svcCode{ color:var(--muted); font-size:12px; margin-top:2px; }
    .rangeLink{
      color:var(--accent);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .rangeLink:hover{ text-decoration:underline; }
    .smallMuted{ color:var(--muted); font-size:12px; white-space:nowrap; }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:999;
    }
    .modal{
      width:min(980px, 100%);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      background:rgba(255,255,255,.98);
      box-shadow: 0 20px 52px rgba(31,37,70,.20);
      overflow:hidden;
    }
    .modal .mh{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .modal .mh .title{ font-weight:900; margin:0; font-size:14px; }
    .x{
      border:1px solid rgba(31,37,70,.24);
      background:rgba(31,37,70,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .x:hover{ background:rgba(31,37,70,.12); }
    .modal .mb{ padding:0; max-height:62vh; overflow:auto; }
    .modal table thead th{ position:sticky; top:0; }
    .modal .footer{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
  
    .noteLink{
      color:var(--accent);
      font-weight:850;
      text-decoration:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .noteLink:hover{ text-decoration:underline; }
    .expRow td{
      padding:0;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.02);
    }
    .expWrap{
      padding:12px;
      display:grid;
      gap:10px;
    }
    .expTitle{
      font-weight:850;
      font-size:13px;
    }
    .expText{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .expGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr .7fr 1fr;
      gap:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      overflow:hidden;
    }
    .expGrid .ghead{
      background:rgba(53,143,151,.10);
      color:var(--muted);
      font-size:11px;
      font-weight:750;
      padding:9px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .expGrid .grow{
      padding:9px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .expGrid .grow:last-child{ border-bottom:none; }
    .expGrid .money{ font-weight:850; }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">
          <img class="brandLogo" src="logo.png" alt="Unraveled logo" onerror="this.style.display='none'" />
          <h1>Unraveled</h1>
        </div>
        <div class="sub">User selected <b>10 services</b> • Plan: <b>Single plan</b> • Area: <b>606xx</b> within <b>20 miles</b></div>
      </div>
      <div class="badge">Click a service price range to drill into multiple “settings”.</div>
    </header>

    <div class="toprow">
      <section class="panel">
        <div class="hd">
          <h2>Selected services</h2>
          <div class="hint">These 10 drive the comparisons below</div>
        </div>
        <div class="controls" id="serviceChips"></div>
      </section>

      <section class="panel">
        <div class="hd">
          <h2>Map</h2>
          <div class="hint">Pins match ranks</div>
        </div>
        <div class="map" id="map">
          <div class="gridlines"></div>
          <div class="mapCard" id="mapCard">
            <p class="t" id="mapCardTitle">—</p>
            <p class="s" id="mapCardAddr">—</p>
            <p class="s">Est. total (10 services): <span class="money" id="mapCardPrice">—</span></p>
            <a class="btn" id="mapCardBtn" href="javascript:void(0)">View details</a>
          </div>
        </div>
      </section>
    </div>

    <section class="panel">
      <div class="hd">
        <h2>Hospitals (ranked by estimated total across selected services)</h2>
        <div class="hint">Click a row to see the per-service breakdown</div>
      </div>

      <div class="controls">
        <div class="chip"><span>ZIP</span> 606xx ▾</div>
        <div class="chip"><span>Radius</span> 20 miles ▾</div>
        <div class="chip"><span>Sort</span> Lowest total ▾</div>
        <div class="input" title="Filters the hospital list only">
          <span style="color:#358f97">Search</span>
          <input id="hospitalSearch" placeholder="e.g., St. Mary’s" />
        </div>
      </div>

      <div style="max-height:340px; overflow:auto;">
        <table id="hospitalTable">
          <thead>
            <tr>
              <th class="rank">Rank</th>
              <th>Hospital</th>
              <th>Est. total (10)</th>
              <th>vs avg</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="panel" id="detailPanel" style="margin-top:14px;">
      <div class="detailHeader">
        <div class="left">
          <p class="name" id="detailName">Select a hospital</p>
          <p class="meta" id="detailMeta">—</p>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Estimated total (10 services)</div>
            <div class="value" id="detailTotal">$—</div>
          </div>
          <div class="kpi">
            <div class="label">Coverage across selected services</div>
            <div class="value" id="detailCoverage">—</div>
          </div>
        </div>
      </div>

      <div class="serviceGrid">
        <table id="serviceTable">
          <thead>
            <tr>
              <th style="min-width:330px;">Service</th>
              <th>Price range</th>
              <th style="min-width:160px;">Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Range details">
    <div class="modal">
      <div class="mh">
        <p class="title" id="modalTitle">—</p>
        <button class="x" id="modalClose" aria-label="Close">✕</button>
      </div>
      <div class="mb">
        <table id="modalTable">
          <thead>
            <tr>
              <th>Setting</th>
              <th>Negotiation arrangement</th>
              <th>Billing class</th>
              <th>Negotiated type</th>
              <th>Range</th>
              <th>NPI count</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer">
        <div>Esc or click outside to close.</div>
        <div style="opacity:.9;">Mock data • Fields reflect your parquet columns</div>
      </div>
    </div>
  </div>

<script>
  const services = [
    {id:"s1", name:"Office visit, new patient", code:"99204"},
    {id:"s2", name:"Office visit, established", code:"99214"},
    {id:"s3", name:"CBC lab panel", code:"85025"},
    {id:"s4", name:"Comprehensive metabolic panel", code:"80053"},
    {id:"s5", name:"X-ray chest (2 views)", code:"71046"},
    {id:"s6", name:"MRI knee w/o contrast", code:"73721"},
    {id:"s7", name:"CT abdomen/pelvis w/ contrast", code:"74177"},
    {id:"s8", name:"Emergency department visit (level 4)", code:"99284"},
    {id:"s9", name:"Vaginal delivery (global)", code:"59400"},
    {id:"s10", name:"Epidural anesthesia", code:"01967"},
  ];

  function fmtMoney(n){ return "$" + Math.round(n).toLocaleString(); }
  function fmtK(n){
    const k = n/1000;
    return "$" + (Math.round(k*10)/10).toFixed(1) + "k";
  }
  function fmtRange(low, high){
    if(high < 2000) return `${fmtMoney(low)}–${fmtMoney(high)}`;
    return `${fmtK(low)}–${fmtK(high)}`;
  }
  function deltaClass(d){ if(d <= -0.08) return "good"; if(d < 0.08) return "warn"; return "bad"; }
  function deltaText(d){
    const pct = Math.round(Math.abs(d)*100);
    if(d < 0) return `-${pct}%`;
    if(d === 0) return `+0%`;
    return `+${pct}%`;
  }

  const hospitals = [
    mkHospital("h1", 1, "River Valley Medical Center", "123 Main St, City, IL 606xx", "4.8 mi", {x:28,y:35}),
    mkHospital("h2", 2, "St. Mary’s Hospital", "8 W Lake Ave, City, IL 606xx", "6.2 mi", {x:52,y:42}),
    mkHospital("h3", 3, "County General Hospital", "400 State Rd, City, IL 606xx", "8.9 mi", {x:70,y:58}),
    mkHospital("h4", 4, "Lakeside Regional", "22 Shore Dr, City, IL 606xx", "12.1 mi", {x:40,y:70}),
    mkHospital("h5", 5, "Metro Women’s Hospital", "77 Health Pkwy, City, IL 606xx", "15.7 mi", {x:78,y:30}),
  ];

  function mkHospital(id, rank, name, address, distance, pin){
    const base = { id, rank, name, address, distance, pin };
    const svc = {};
    services.forEach((s, i) => {
      const rankFactor = (rank-3) * 0.06;
      const type = s.id;

      let mid;
      if(type==="s1") mid = 240 + 60*rank;
      if(type==="s2") mid = 160 + 45*rank;
      if(type==="s3") mid = 55 + 15*rank;
      if(type==="s4") mid = 90 + 20*rank;
      if(type==="s5") mid = 180 + 55*rank;
      if(type==="s6") mid = 1400 + 260*rank;
      if(type==="s7") mid = 2100 + 420*rank;
      if(type==="s8") mid = 1100 + 260*rank;
      if(type==="s9") mid = 7200 + 950*rank;
      if(type==="s10") mid = 2400 + 320*rank;

      mid = mid * (1 + rankFactor);
      const low = Math.max(20, Math.round(mid * 0.85));
      const high = Math.round(mid * 1.15);

      const settingCount = (i % 3 === 0) ? 2 : 3;
      const settings = [];
      for(let k=0; k<settingCount; k++){
        const shift = (k - (settingCount-1)/2) * 0.06;
        const sLow = Math.round(low * (1 + shift));
        const sHigh = Math.round(high * (1 + shift));
        settings.push({
          setting: `Setting ${String.fromCharCode(65+k)}`,
          arrangement: `arrangement_${k+1}`,
          billingClass: (k===2 && (type==="s9" || type==="s10")) ? "professional" : "facility",
          negotiatedType: "negotiated",
          low: sLow,
          high: sHigh,
          npi: Math.max(4, Math.round(6 + (10-rank) + (Math.random()*6)))
        });
      }

      svc[s.id] = { low, high, note: `(${settingCount} settings)`, settings };
    });

    // simulate missing services
    if(id==="h4"){ delete svc["s3"]; delete svc["s4"]; }
    if(id==="h5"){ delete svc["s5"]; delete svc["s1"]; delete svc["s2"]; }

    base.services = svc;
    return base;
  }

  function computeTotal(h){
    let lowSum = 0, highSum = 0, present = 0;
    services.forEach(s => {
      const e = h.services[s.id];
      if(e){ lowSum += e.low; highSum += e.high; present += 1; }
    });
    return { low: lowSum, high: highSum, present, coveragePct: Math.round(100 * (present / services.length)) };
  }
  function computeLocalAverage(){
    const mids = hospitals.map(h => {
      const t = computeTotal(h);
      return (t.low + t.high) / 2;
    });
    return mids.reduce((a,b)=>a+b,0)/mids.length;
  }
  const localAvg = computeLocalAverage();

  const chipWrap = document.getElementById("serviceChips");
  const hospTbody = document.querySelector("#hospitalTable tbody");
  const hospSearch = document.getElementById("hospitalSearch");

  const map = document.getElementById("map");
  const mapCard = document.getElementById("mapCard");
  const mapCardTitle = document.getElementById("mapCardTitle");
  const mapCardAddr = document.getElementById("mapCardAddr");
  const mapCardPrice = document.getElementById("mapCardPrice");
  const mapCardBtn = document.getElementById("mapCardBtn");

  const detailName = document.getElementById("detailName");
  const detailMeta = document.getElementById("detailMeta");
  const detailTotal = document.getElementById("detailTotal");
  const detailCoverage = document.getElementById("detailCoverage");
  const svcTbody = document.querySelector("#serviceTable tbody");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalClose = document.getElementById("modalClose");
  const modalTitle = document.getElementById("modalTitle");
  const modalTableBody = document.querySelector("#modalTable tbody");

  let selectedHospitalId = null;

  function renderServiceChips(){
    chipWrap.innerHTML = "";
    services.forEach(s => {
      const el = document.createElement("div");
      el.className = "chip";
      el.innerHTML = `<span>${s.code}</span> ${s.name}`;
      chipWrap.appendChild(el);
    });
  }

  function renderHospitalRows(filter=""){
    hospTbody.innerHTML = "";
    const f = filter.trim().toLowerCase();

    hospitals.forEach(h => {
      if(f && !h.name.toLowerCase().includes(f) && !h.address.toLowerCase().includes(f)) return;

      const t = computeTotal(h);
      const mid = (t.low + t.high)/2;
      const delta = (mid - localAvg)/localAvg;

      const tr = document.createElement("tr");
      tr.dataset.id = h.id;
      tr.innerHTML = `
        <td class="rank">${h.rank}</td>
        <td>
          <div class="hospital">${h.name}</div>
          <div class="addr">${h.address}</div>
        </td>
        <td><span class="money">${fmtRange(t.low, t.high)}</span></td>
        <td><span class="pill"><span class="delta ${deltaClass(delta)}">${deltaText(delta)}</span> vs avg</span></td>
      `;
      tr.addEventListener("click", () => selectHospital(h.id));
      tr.addEventListener("mouseenter", () => highlightPin(h.id, true));
      tr.addEventListener("mouseleave", () => highlightPin(h.id, false));
      hospTbody.appendChild(tr);
    });
  }

  function renderPins(){
    [...map.querySelectorAll(".pin")].forEach(p => p.remove());

    hospitals.forEach(h => {
      const pin = document.createElement("div");
      pin.className = "pin";
      pin.dataset.id = h.id;
      pin.style.left = h.pin.x + "%";
      pin.style.top = h.pin.y + "%";
      pin.textContent = h.rank;
      pin.title = h.name;
      pin.addEventListener("click", (e) => {
        e.stopPropagation();
        selectHospital(h.id);
        showMapCard(h.id);
      });
      map.appendChild(pin);
    });

    map.addEventListener("click", () => { mapCard.style.display = "none"; });
  }

  function showMapCard(id){
    const h = hospitals.find(x => x.id === id);
    if(!h) return;
    const t = computeTotal(h);
    mapCardTitle.textContent = `#${h.rank} ${h.name}`;
    mapCardAddr.textContent = h.address;
    mapCardPrice.textContent = fmtRange(t.low, t.high);
    mapCard.style.display = "block";
    mapCardBtn.onclick = () => selectHospital(id);
  }

  function setActiveRow(id){
    [...hospTbody.querySelectorAll("tr")].forEach(tr => tr.classList.toggle("active", tr.dataset.id === id));
  }
  function setActivePin(id){
    [...map.querySelectorAll(".pin")].forEach(p => p.classList.toggle("active", p.dataset.id === id));
  }
  function highlightPin(id, on){
    const pin = map.querySelector(`.pin[data-id="${id}"]`);
    if(!pin) return;
    if(on) pin.classList.add("active");
    else if(id !== selectedHospitalId) pin.classList.remove("active");
  }

  function selectHospital(id){
    selectedHospitalId = id;
    const h = hospitals.find(x => x.id === id);
    if(!h) return;

    setActiveRow(id);
    setActivePin(id);

    const t = computeTotal(h);
    detailName.textContent = h.name;
    detailMeta.textContent = `${h.address} • ${h.distance}`;
    detailTotal.textContent = fmtRange(t.low, t.high);
    detailCoverage.textContent = `${t.coveragePct}% (${t.present}/${services.length} services)`;

    renderServiceBreakdown(h);
  }

  function renderServiceBreakdown(h){
    svcTbody.innerHTML = "";
    services.forEach(s => {
      const entry = h.services[s.id];
      const tr = document.createElement("tr");

      const nameCell = `
        <div class="serviceName">${s.name}</div>
        <div class="svcCode">Code: ${s.code}</div>
      `;

      if(!entry){
        tr.innerHTML = `
          <td>${nameCell}</td>
          <td class="smallMuted">Not available</td>
          <td class="smallMuted">—</td>
        `;
        svcTbody.appendChild(tr);
        return;
      }

      tr.innerHTML = `
        <td>${nameCell}</td>
        <td><a class="rangeLink" href="javascript:void(0)" data-svc="${s.id}">${fmtMoney(entry.low)}–${fmtMoney(entry.high)}</a></td>
        <td><a class="noteLink" href="javascript:void(0)" data-svc="${s.id}">${entry.note}</a></td>
      `;
      svcTbody.appendChild(tr);

      // expandable explanation row (hidden by default)
      const exp = document.createElement("tr");
      exp.className = "expRow";
      exp.dataset.expFor = s.id;
      exp.style.display = "none";

      // Choose a single "typical" price from settings:
      // Here: median of setting midpoints (robust to outliers). You can swap to mode/most-common later.
      const mids = entry.settings
        .map(x => (x.low + x.high) / 2)
        .sort((a,b) => a-b);
      const typical = mids.length % 2 === 1
        ? mids[(mids.length-1)/2]
        : (mids[mids.length/2 - 1] + mids[mids.length/2]) / 2;

      exp.innerHTML = `
        <td colspan="3">
          <div class="expWrap">
            <div class="expTitle">Why is this a range? What is the “typical” price?</div>
            <div class="expText">
              The MRF may list multiple negotiated rates for the same service at the same hospital because the rate depends on the
              <b>contract/benefit context</b> (what I’m calling “settings”). A setting is a distinct combination of
              <b>negotiation_arrangement</b>, <b>billing_class</b> (facility vs professional), and <b>negotiated_type</b>.
              The range above is the <b>min–max</b> across settings for this hospital + service.
            </div>
            <div class="expText">
              For a single actionable number, we compute a <b>typical price</b> from those settings. In this mock, it’s the
              <b>median</b> of setting midpoints.
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <div class="pill" style="border-color: rgba(53,143,151,.35); background: rgba(53,143,151,.16);">
                Typical price: <span class="money">${fmtMoney(typical)}</span>
              </div>
              <a class="btn" href="javascript:void(0)" data-svc="${s.id}" data-action="openSettings">View settings</a>
            </div>
          </div>
        </td>
      `;
      svcTbody.appendChild(exp);
    });

    // range link opens modal
    svcTbody.querySelectorAll(".rangeLink").forEach(a => {
      a.addEventListener("click", (e) => {
        const svcId = e.target.dataset.svc;
        openModal(h, svcId);
      });
    });

    // note link toggles expansion
    svcTbody.querySelectorAll(".noteLink").forEach(a => {
      a.addEventListener("click", (e) => {
        const svcId = e.target.dataset.svc;
        toggleExpander(svcId);
      });
    });


    // button inside expander opens settings modal
    svcTbody.querySelectorAll('[data-action="openSettings"]').forEach(btn => {
      btn.addEventListener("click", (e) => {
        const svcId = e.target.dataset.svc;
        openModal(h, svcId);
      });
    });

  }

  
  function toggleExpander(svcId){
    // Close all other expanded rows
    svcTbody.querySelectorAll('tr.expRow').forEach(r => {
      if(r.dataset.expFor !== svcId) r.style.display = "none";
    });

    // Toggle this service's expander row
    const target = svcTbody.querySelector(`tr.expRow[data-exp-for="${svcId}"]`);
    if(!target) return;

    const isOpen = target.style.display === "table-row";
    target.style.display = isOpen ? "none" : "table-row";

    if(!isOpen){
      target.scrollIntoView({behavior:"smooth", block:"nearest"});
    }
  }

function openModal(h, svcId){
    const s = services.find(x => x.id === svcId);
    const entry = h.services[svcId];
    if(!s || !entry) return;

    modalTitle.textContent = `${s.name} (${s.code}) — Price Details (${h.name})`;
    modalTableBody.innerHTML = "";

    entry.settings.forEach(set => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${set.setting}</td>
        <td>${set.arrangement}</td>
        <td>${set.billingClass}</td>
        <td>${set.negotiatedType}</td>
        <td class="money">${fmtMoney(set.low)}–${fmtMoney(set.high)}</td>
        <td>${set.npi}</td>
      `;
      modalTableBody.appendChild(tr);
    });

    modalBackdrop.style.display = "flex";
  }

  function closeModal(){ modalBackdrop.style.display = "none"; }
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if(e.target === modalBackdrop) closeModal(); });
  window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

  hospSearch.addEventListener("input", () => renderHospitalRows(hospSearch.value));

  // init
  renderServiceChips();
  renderPins();
  renderHospitalRows("");
  selectHospital("h2");
  showMapCard("h2");
</script>
</body>
</html>
